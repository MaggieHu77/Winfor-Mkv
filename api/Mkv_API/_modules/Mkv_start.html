
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_cn">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Mkv_start &#8212; mkv v0.6.2.190517_beta 文档</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Mkv_start 源代码</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="c1"># ! python3</span>

<span class="kn">from</span> <span class="nn">configparser</span> <span class="k">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span> <span class="nn">Mkv_constant</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">makedirs</span><span class="p">,</span> <span class="n">mkdir</span>
<span class="c1"># import win32com.client as wc</span>
<span class="kn">from</span> <span class="nn">openpyxl</span> <span class="k">import</span> <span class="n">load_workbook</span><span class="p">,</span> <span class="n">Workbook</span>
<span class="kn">from</span> <span class="nn">xlrd</span> <span class="k">import</span> <span class="n">open_workbook</span>
<span class="kn">from</span> <span class="nn">Mkv_data2</span> <span class="k">import</span> <span class="n">create_stocks</span><span class="p">,</span> <span class="n">calc_params</span>
<span class="kn">from</span> <span class="nn">Mkv_optimize2</span> <span class="k">import</span> <span class="n">optimizer</span>
<span class="kn">from</span> <span class="nn">Mkv_pointwise_dates</span> <span class="k">import</span> <span class="n">BTdate</span>
<span class="kn">from</span> <span class="nn">Mkv_eval</span> <span class="k">import</span> <span class="n">MkvEval</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">WindPy</span> <span class="k">import</span> <span class="n">w</span>


<div class="viewcode-block" id="Manage"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage">[文档]</a><span class="k">class</span> <span class="nc">Manage</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设定运行基本信息</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_t</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="s2">&quot;M&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># self.first_t = &quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span> <span class="o">=</span> <span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="n">DEFAULT_UP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span> <span class="o">=</span> <span class="n">CASH_RETURN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span> <span class="o">=</span> <span class="n">DEFAULT_VOL</span> <span class="o">/</span> <span class="n">N</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_now</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stocks_panel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_eval_seq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_panel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_panel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_panel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_conf</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_code_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_work_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_mode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cons_vol</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cons_up</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cash_return</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_num_d</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_short</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">CONF_NAME</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_codes</span><span class="p">()</span>

<div class="viewcode-block" id="Manage.init_conf"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.init_conf">[文档]</a>    <span class="k">def</span> <span class="nf">init_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        初始化参数配置文件</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CONF_NAME</span><span class="p">,</span> <span class="s2">&quot;a+&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">CONF_NAME</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;gbk&quot;</span><span class="p">)</span>
        <span class="c1"># self.conf.read_file(codecs.open(CONF_NAME, &quot;r&quot;, encoding=&quot;gbk&quot;))</span>
        <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">CONF_DICT</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">sec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">CONF_DICT</span><span class="p">[</span><span class="n">sec</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">CONF_DICT</span><span class="p">[</span><span class="n">sec</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-*-欢迎使用Markovitz组合优化系统 </span><span class="si">{VERSION}</span><span class="s2">-*-&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_code_file"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_code_file">[文档]</a>    <span class="k">def</span> <span class="nf">set_code_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        从键盘读取文件地址</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;code_file&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Part 1: 地址参数&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1.1 股票代码文件地址&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前股票代码文件地址：</span><span class="si">{code_dir}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">code_dir_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;-请输入股票代码文件【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">code_dir_input</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">code_dir</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">FILE_EMPTY_MSG</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">code_dir</span> <span class="o">=</span> <span class="n">code_dir</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">code_dir_input</span><span class="p">):</span>
                <span class="n">code_dir_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">FILE_EXIST_MSG</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code_dir</span> <span class="o">=</span> <span class="n">code_dir_input</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;code_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_dir</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Manage.set_work_file"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_work_file">[文档]</a>    <span class="k">def</span> <span class="nf">set_work_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        从键盘读入工作文件夹地址</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;1.2 工作文件夹地址&quot;</span><span class="p">)</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;work_file&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前工作文件夹地址：</span><span class="si">{work_dir}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">work_dir_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-请输入工作文件夹地址【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work_dir_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;/Mkv_output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">work_dir</span><span class="p">:</span>
                <span class="n">work_dir</span> <span class="o">+=</span> <span class="s2">&quot;/Mkv_output&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir</span><span class="p">):</span>
                <span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir_input</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;/Mkv_output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">work_dir_input</span><span class="p">:</span>
                <span class="n">work_dir_input</span> <span class="o">+=</span> <span class="s2">&quot;/Mkv_output&quot;</span>
            <span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir_input</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;该文件夹不存在，已为您新建</span><span class="si">{work_dir_input}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir_input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;/Mkv_output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">work_dir_input</span><span class="p">:</span>
                <span class="n">work_dir_input</span> <span class="o">+=</span> <span class="s2">&quot;/Mkv_output&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir_input</span><span class="p">):</span>
                <span class="n">mkdir</span><span class="p">(</span><span class="n">work_dir_input</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir_input</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">work_dir_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;work_file&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_mode"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_mode">[文档]</a>    <span class="k">def</span> <span class="nf">set_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设置运行模式</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Part 2: 运行参数&quot;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;当前运行模式：mode=</span><span class="si">{mode}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">mode_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;请选择运行模式【1=回测模式，2=今日实盘模式，无需更改请直接回车】:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mode_input</span> <span class="ow">or</span> <span class="n">mode_input</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span> <span class="ow">or</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mode参数设置错误，请重新设置&quot;</span><span class="p">)</span>
                    <span class="n">mode_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;请选择运行模式【1=回测模式，2=今日实盘模式，无需更改请直接回车】:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode_input</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">mode_input</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_time_interval</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_calc_time</span><span class="p">()</span></div>

<div class="viewcode-block" id="Manage.set_time_interval"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_time_interval">[文档]</a>    <span class="k">def</span> <span class="nf">set_time_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.1 回测时间区间&quot;</span><span class="p">)</span>
        <span class="n">start_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前回测开始时间设定：</span><span class="si">{start_t}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start_t_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;-请输入回测开始时间，格式yyyy-mm-dd【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start_t_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_t</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">DEFAULT_START_T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">start_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">start_t_input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span>
        <span class="n">end_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;end_time&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前回测结束时间设定：</span><span class="si">{end_t}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">end_t_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;-请输入回测结束时间，格式yyyy-mm-dd【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end_t_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">end_t</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="n">DEFAULT_END_T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="n">end_t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="n">end_t_input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;end_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_frequency</span><span class="p">()</span></div>

<div class="viewcode-block" id="Manage.set_frequency"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_frequency">[文档]</a>    <span class="k">def</span> <span class="nf">set_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;设置回测频率&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.2.1 回测频率&quot;</span><span class="p">)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;当前回测频率设定：</span><span class="si">{freq}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">freq_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;请输入回测时间间隔/频率【M-每月回测，W-每周回测，D-每日回测】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">freq_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">freq_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">freq_input</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">],</span> \
                <span class="s2">&quot;输入回测频率&#39;</span><span class="si">%s</span><span class="s2">&#39;不支持&quot;</span> <span class="o">%</span> <span class="n">freq_input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq_input</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">freq_input</span><span class="p">)</span></div>


<div class="viewcode-block" id="Manage.set_calc_time"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_calc_time">[文档]</a>    <span class="k">def</span> <span class="nf">set_calc_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设置当日盘中价格截止时间</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.1 价格截止时间&quot;</span><span class="p">)</span>
        <span class="n">calc_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;calc_time&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前截止时间设定：</span><span class="si">{calc_time}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">calc_time_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;-请输入计算截止时间，格式yyyy-mm-dd HH:MM:SS【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_time_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_now</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">re</span> <span class="k">import</span> <span class="n">split</span>
                <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split</span><span class="p">(</span><span class="s2">&quot;[:\- ]&quot;</span><span class="p">,</span> <span class="n">calc_time</span><span class="p">)]</span>
                <span class="c1"># 补齐数组长度，防止用户漏写</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;00&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_t</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                               <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">re</span> <span class="k">import</span> <span class="n">split</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">split</span><span class="p">(</span><span class="s2">&quot;[:\- ]&quot;</span><span class="p">,</span> <span class="n">calc_time_input</span><span class="p">)]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;00&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_t</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                           <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">])}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;calc_time&quot;</span><span class="p">,</span> <span class="n">calc_time_input</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_cons_vol"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_cons_vol">[文档]</a>    <span class="k">def</span> <span class="nf">set_cons_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        设置优化的年化波动率约束</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.2 年化波动率约束&quot;</span><span class="p">)</span>
        <span class="n">cons_vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;vol&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前年化波动率约束：</span><span class="si">{cons_vol}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cons_vol_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;-请输入年化波动率约束【请用小数表示，如0.15;不需修改请直接回车】（&lt;=）</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cons_vol_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cons_vol</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span> <span class="o">=</span> <span class="n">DEFAULT_VOL</span> <span class="o">/</span> <span class="n">N</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cons_vol</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cons_vol_input</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;vol&quot;</span><span class="p">,</span> <span class="n">cons_vol_input</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_cons_up"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_cons_up">[文档]</a>    <span class="k">def</span> <span class="nf">set_cons_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.3 单股最大权重约束&quot;</span><span class="p">)</span>
        <span class="n">up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;max_weight&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;-当前单股最大权重约束：</span><span class="si">{up}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">up_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;请输入单股最大权重（现金资产不受此约束，包括多头和空头）【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">up_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">up</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">up</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">up_input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;max_weight&quot;</span><span class="p">,</span> <span class="n">up_input</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_cash_return"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_cash_return">[文档]</a>    <span class="k">def</span> <span class="nf">set_cash_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.4 现金年化收益率&quot;</span><span class="p">)</span>
        <span class="n">cash_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;cash_return&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前设置的现金年化收益率：</span><span class="si">{cash_r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cash_r_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;请输入现金年化收益率【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cash_r_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cash_r</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cash_r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cash_r_input</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;cash_return&quot;</span><span class="p">,</span> <span class="n">cash_r_input</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_num_d"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_num_d">[文档]</a>    <span class="k">def</span> <span class="nf">set_num_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.4 历史收益率交易日长度&quot;</span><span class="p">)</span>
        <span class="n">num_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;num_d&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前收益率历史交易日长度：</span><span class="si">{num_d}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">num_d_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;-请输入历史收益率交易日长度【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_d_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_d_input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;calculation&quot;</span><span class="p">,</span> <span class="s2">&quot;num_d&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_d</span><span class="p">))</span></div>

<div class="viewcode-block" id="Manage.set_short"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_short">[文档]</a>    <span class="k">def</span> <span class="nf">set_short</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;2.5 做空约束&quot;</span><span class="p">)</span>
        <span class="n">short</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;short&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-当前做空约束：</span><span class="si">{short}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">short_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;-请选择是否允许空头头寸，1=允许做空，0=不允许做空【不需修改请直接回车】：</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">short_input</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">short</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">SHORT_MISS_WARNING</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">short</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">short_input</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="s2">&quot;short&quot;</span><span class="p">,</span> <span class="n">short_input</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.read_codes"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.read_codes">[文档]</a>    <span class="k">def</span> <span class="nf">read_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        从文件中读取代码</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*************************************************************&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codes</span> <span class="o">=</span> <span class="n">read_codes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;%读取{len(self.codes)}只股票&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.set_params1"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_params1">[文档]</a>    <span class="k">def</span> <span class="nf">set_params1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        回测模式的优化计算</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-正在回测时点</span><span class="si">{tt}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">stocks</span> <span class="o">=</span> <span class="n">create_stocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stocks_panel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tt</span><span class="p">:</span> <span class="n">stocks</span><span class="p">})</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">calc_params</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;vol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">,</span> <span class="s2">&quot;cash_r&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu_panel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tt</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_panel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tt</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;cov&quot;</span><span class="p">]})</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w_panel</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">tt</span><span class="p">:</span> <span class="n">w</span><span class="p">})</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;--Backtest[</span><span class="si">{tt}</span><span class="s2">] output:{np.matmul(np.matmul(np.array(w), params[&#39;cov&#39;]), np.array(w).T)}&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;--constraint:{self.cons_vol**2}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_output1</span><span class="p">()</span></div>

<div class="viewcode-block" id="Manage.set_params2"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.set_params2">[文档]</a>    <span class="k">def</span> <span class="nf">set_params2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        实盘问题的计算优化参数</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">q</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stocks</span> <span class="o">=</span> <span class="n">create_stocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span><span class="p">,</span>
                                        <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_t</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                                        <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stocks</span> <span class="o">=</span> <span class="n">create_stocks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">calc_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;vol&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_vol</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">up</span><span class="p">,</span> <span class="s2">&quot;cash_r&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;output:&quot;</span>
            <span class="n">f</span><span class="s2">&quot;{np.matmul(np.matmul(np.array(self.w), self.params[&#39;cov&#39;]), np.array(self.w).T)}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">f</span><span class="s2">&quot;constraint:{self.cons_vol**2}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_output2</span><span class="p">()</span></div>

<div class="viewcode-block" id="Manage.get_backtest_t_seq"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.get_backtest_t_seq">[文档]</a>    <span class="k">def</span> <span class="nf">get_backtest_t_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bt_obj</span> <span class="o">=</span> <span class="n">BTdate</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">,</span>
                        <span class="n">end</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">,</span>
                        <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span> <span class="o">=</span> <span class="n">bt_obj</span><span class="o">.</span><span class="n">get_backtest_dates</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_eval_seq</span> <span class="o">=</span> <span class="n">bt_obj</span><span class="o">.</span><span class="n">get_eval_dates</span><span class="p">(</span><span class="n">ref_seq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">)</span></div>
        <span class="c1"># self.first_t = bt_obj.get_backtest_first_date(num_d=self.num_d)</span>

<div class="viewcode-block" id="Manage.run_optimizer"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.run_optimizer">[文档]</a>    <span class="k">def</span> <span class="nf">run_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_backtest_t_seq</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;-*-进入回测模式，检测到{len(self.t_seq)}个回测时点-*-&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_params1</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">calc_t</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_t</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="c1"># 给定日期非当天，用于回测而非实盘</span>
            <span class="k">if</span> <span class="n">calc_t</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">stamp</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_params2</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># 给定日期在当天或者在未来，都当做在当天进行</span>
            <span class="k">elif</span> <span class="n">calc_t</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">stamp</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_params2</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">calc_t</span> <span class="o">&lt;=</span> <span class="n">stamp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_params2</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">delta_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc_t</span> <span class="o">-</span> <span class="n">stamp</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;%定时等待运行...&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">sleep</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_params2</span><span class="p">()</span></div>

<div class="viewcode-block" id="Manage.write_output1"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.write_output1">[文档]</a>    <span class="k">def</span> <span class="nf">write_output1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;weights&quot;</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
        <span class="n">token</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="s2">&quot;weekly&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="s2">&quot;daily&quot;</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">]</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;portfolio </span><span class="si">%s</span><span class="s2"> returns&quot;</span> <span class="o">%</span> <span class="n">token</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.num_d}</span><span class="s2">-day mean returns&quot;</span>
        <span class="c1"># 写第一张表回测各周期weights</span>
        <span class="n">col11</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codes</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;cash&quot;</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stocks_panel</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
        <span class="n">col12</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">names</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;现金&quot;</span><span class="p">]</span>
        <span class="n">content1</span> <span class="o">=</span> <span class="p">[</span><span class="n">col11</span><span class="p">,</span> <span class="n">col12</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">:</span>
            <span class="n">content1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tt</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_panel</span><span class="p">[</span><span class="n">tt</span><span class="p">])</span>
        <span class="n">content1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">content1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">content1</span><span class="p">:</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="c1"># 写第二张表回测权重持有至下一期的组合期间收益率</span>
        <span class="n">eval_obj</span> <span class="o">=</span> <span class="n">MkvEval</span><span class="p">(</span><span class="n">eval_seq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_eval_seq</span><span class="p">,</span>
                           <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                           <span class="n">stocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">codes</span><span class="p">,</span>
                           <span class="n">cash_r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">eval_obj</span><span class="o">.</span><span class="n">eval_returns</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="s2">&quot;pct_chg&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">dot</span>
        <span class="n">col22</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;portfolio return(%)&quot;</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">[</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_panel</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]],</span> <span class="n">returns</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span>
                                         <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">))]</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;evaluation_date&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_eval_seq</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col22</span><span class="p">)</span>
        <span class="c1"># 写第三张表</span>
        <span class="n">content3</span> <span class="o">=</span> <span class="p">[</span><span class="n">col11</span><span class="p">,</span> <span class="n">col12</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">:</span>
            <span class="n">content3</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tt</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_panel</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span><span class="p">])</span>
        <span class="n">content3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">content3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">content3</span><span class="p">:</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># 写回测期间协方差的表</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">)):</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;s{4+t}=wb.create_sheet()&quot;</span><span class="p">)</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;s{4+t}.title=&#39;Cov_</span><span class="si">{self.t_seq[t]}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_panel</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t_seq</span><span class="p">[</span><span class="n">t</span><span class="p">]]:</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;s{4+t}.append({list(row)})&quot;</span><span class="p">)</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.work_dir}</span><span class="s2">/mkv_{path.splitext(path.basename(self.code_dir))[0]}&quot;</span><span class="o">+</span> \
            <span class="n">f</span><span class="s2">&quot;_{[&#39;longOnly&#39;, &#39;short&#39;][self.short]}_&quot;</span> \
            <span class="n">f</span><span class="s2">&quot;{&#39;&#39;.join(self.start_t.split(&#39;-&#39;))}-{&#39;&#39;.join(self.end_t.split(&#39;-&#39;))}.xlsx&quot;</span>
        <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;%结果输出到：</span><span class="si">{output_dir}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Manage.write_output2"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.Manage.write_output2">[文档]</a>    <span class="k">def</span> <span class="nf">write_output2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;weights&quot;</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.num_d}</span><span class="s2">-days mean returns&quot;</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">()</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;covariance&quot;</span>
        <span class="c1"># 写第一张表-weight</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">)):</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">cc</span><span class="p">])</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;cash&quot;</span><span class="p">)</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;现金&quot;</span><span class="p">)</span>
        <span class="n">s1</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 写第二张表-return</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;mu&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">)):</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;mu&quot;</span><span class="p">][</span><span class="n">cc</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
                <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">t</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">t</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;cash&quot;</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;现金&quot;</span><span class="p">)</span>
        <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">)):</span>
            <span class="n">s2</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">t</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cash_r</span><span class="p">)</span>
        <span class="c1"># 写第三张表-covariance</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="n">s3</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">)):</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">cc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stocks</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;qval&#39;</span><span class="p">])):</span>
            <span class="n">s3</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;qsubi&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;qsubj&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;qval&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.work_dir}</span><span class="s2">/mkv_{path.splitext(path.basename(self.code_dir))[0]}&quot;</span><span class="o">+</span> \
            <span class="n">f</span><span class="s2">&quot;_{[&#39;longOnly&#39;, &#39;short&#39;][self.short]}_{datetime(*self.calc_t.values()).strftime(&#39;%y%m</span><span class="si">%d</span><span class="s2">&#39;)}.xlsx&quot;</span>
        <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;%结果输出到：</span><span class="si">{output_dir}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="read_codes"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.read_codes">[文档]</a><span class="k">def</span> <span class="nf">read_codes</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">b_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">b_type</span> <span class="o">=</span> <span class="n">b_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># if b_type == &#39;xls&#39;:</span>
    <span class="c1">#     # openpyxl不支持xls格式，先转化为xls</span>
    <span class="c1">#     e = wc.gencache.EnsureDispatch(&#39;Excel.Application&#39;)</span>
    <span class="c1">#     wb = e.Workbooks.Open(f)</span>
    <span class="c1">#     wb.SaveAs(f + &#39;x&#39;, FileFormat=51)</span>
    <span class="c1">#     wb.Close()</span>
    <span class="c1">#     e.Application.Quit()</span>
    <span class="c1">#     f = f + &#39;x&#39;</span>
    <span class="c1">#     b_type = &#39;xlsx&#39;</span>
    <span class="k">if</span> <span class="n">b_type</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">|;|,|/|&quot;</span><span class="p">)</span>
            <span class="n">codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">b_type</span> <span class="o">==</span> <span class="s2">&quot;xlsx&quot;</span><span class="p">:</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">load_workbook</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">code</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">b_type</span> <span class="o">==</span> <span class="s1">&#39;xls&#39;</span><span class="p">:</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">open_workbook</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">col_values</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
                <span class="n">codes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error: 不支持的文件格式</span><span class="si">{b_type}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">codes</span></div>


<div class="viewcode-block" id="test_read_codes"><a class="viewcode-back" href="../Mkv_start.html#Mkv_start.test_read_codes">[文档]</a><span class="k">def</span> <span class="nf">test_read_codes</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="s2">&quot;C:/Users/Maggie/Desktop/test.xls&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read_codes函数的单元测试</span>
<span class="sd">    :param f: 文件地址</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">read_codes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Manage</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">run_optimizer</span><span class="p">()</span>








</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Maggie Hu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>